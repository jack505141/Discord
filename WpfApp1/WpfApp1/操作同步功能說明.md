# WPF 多台連線系統 - 操作同步功能說明

## ?? 功能概述

系統現在支援**保持連線狀態下的操作同步**功能：

- ? **連線保持在背景**：即使關閉 MultiConnect 視窗，連線仍然保持
- ? **主視窗操作同步**：在主視窗執行的操作會自動同步到所有連線的客戶端
- ? **自動執行同步**：客戶端收到操作指令後會自動執行相同動作
- ? **靈活控制**：可以隨時開關自動同步功能

---

## ?? 快速開始（操作同步）

### 步驟一：建立連線

1. **打開主視窗**，點擊頂部的 **「開啟連線管理」** 按鈕
2. **MultiConnect 視窗**中：
   - **伺服器端**：點擊「啟動伺服器」
   - **客戶端**：輸入伺服器 IP，點擊「連線」
3. 連線成功後，可以**關閉 MultiConnect 視窗**，連線會保持在背景運行

### 步驟二：確認連線狀態

回到主視窗，查看頂部的**連線狀態區域**：
- ?? **伺服器運行中 (X 個客戶端)** - 表示您是伺服器
- ?? **已連線到伺服器** - 表示您是客戶端
- ?? **未連線** - 表示沒有建立連線

### 步驟三：執行操作並同步

1. **確認「自動同步操作」已勾選**
2. 在主視窗點擊任何按鈕，例如：
   - ?? 組裝Kiosk
   - ?? 一鍵更新
   - 備份kiosk
   - 更改kiosk Config
3. **所有連線的客戶端會自動執行相同的操作！**

---

## ?? 支援同步的操作

目前系統支援以下操作的自動同步：

| 操作按鈕 | 動作名稱 | 說明 |
|---------|---------|------|
| ?? 更新Kiosk | `UpdateGit` | 更新 Git 儲存庫 |
| ?? 組裝Kiosk | `AssembleKiosk` | 組裝 Kiosk 檔案 |
| ?? 一鍵更新 | `ALL_Assemble` | 完整更新流程 |
| 備份kiosk | `Backup` | 備份 Kiosk |
| 更改kiosk Config | `ModifyConfig` | 修改配置檔 |

---

## ?? 使用場景

### 場景一：多台電腦同時更新（最常用）

**情境**：您有 5 台 Kiosk 機器需要同時更新

**步驟**：
1. **在您的管理電腦上啟動伺服器**
2. **在 5 台 Kiosk 機器上都連線到您的伺服器**
3. **在您的管理電腦上點擊「一鍵更新」**
4. **5 台 Kiosk 機器會自動開始更新！**

**優點**：
- 不用逐台操作
- 確保所有機器執行相同步驟
- 節省大量時間

### 場景二：遠端協助操作

**情境**：您需要協助遠端的同事操作

**步驟**：
1. **您啟動伺服器**
2. **同事連線到您的伺服器（使用 Tailscale IP）**
3. **您在您的電腦上操作**
4. **同事的電腦會同步執行相同操作**

**優點**：
- 即時協助
- 確保步驟正確
- 適合教學和示範

### 場景三：測試流程（開發人員）

**情境**：測試更新流程是否正確

**步驟**：
1. **在同一台電腦開啟多個視窗**
2. **一個當伺服器，其他當客戶端**
3. **執行操作，觀察所有視窗的反應**

**優點**：
- 快速測試
- 不需要多台實體機器
- 方便除錯

---

## ?? 設定選項

### 自動同步開關

主視窗頂部有「**自動同步操作**」核取方塊：

- ? **勾選（預設）**：執行操作時會自動廣播/發送給其他客戶端
- ? **不勾選**：執行操作時不會同步，僅在本機執行

**使用時機**：
- 勾選：正常多台同步操作時
- 不勾選：只想在本機測試，不影響其他機器時

### 連線管理

點擊「**開啟連線管理**」可以隨時：
- 查看連線狀態
- 啟動/停止伺服器
- 連線/斷線
- 查看日誌訊息

---

## ?? 狀態訊息說明

### 主視窗狀態訊息

執行操作時，狀態區域會顯示：

```
?? 已廣播動作: AssembleKiosk      ← 伺服器端廣播
?? 收到同步動作: AssembleKiosk    ← 客戶端收到
? 執行同步動作: 組裝Kiosk         ← 開始執行
```

### 連線狀態顯示

頂部連線狀態會即時更新：

- **伺服器模式**：
  ```
  ?? 伺服器運行中 (3 個客戶端)
  ```

- **客戶端模式**：
  ```
  ?? 已連線到伺服器
  ```

- **未連線**：
  ```
  ?? 未連線
  ```

---

## ?? 詳細操作流程

### 一、啟動伺服器（管理端）

1. **開啟程式，進入主視窗**
2. **點擊「開啟連線管理」**
3. **MultiConnect 視窗中：**
   - 確認埠號（預設 5000）
   - 點擊「啟動伺服器」
   - 記下本機 IP（例如：192.168.1.100）
4. **關閉 MultiConnect 視窗**（連線保持運行）
5. **確認主視窗頂部顯示「伺服器運行中」**

### 二、連線客戶端（被控端）

**在每台需要同步的機器上：**

1. **開啟程式，進入主視窗**
2. **點擊「開啟連線管理」**
3. **MultiConnect 視窗中：**
   - 輸入伺服器 IP（例如：192.168.1.100）
   - 輸入埠號（5000）
   - 點擊「連線」
4. **看到「已連線」訊息後，關閉 MultiConnect 視窗**
5. **確認主視窗頂部顯示「已連線到伺服器」**

### 三、執行同步操作

**在伺服器端（管理端）：**

1. **確認「自動同步操作」已勾選**
2. **點擊任何操作按鈕**（例如：一鍵更新）
3. **觀察狀態訊息顯示「已廣播動作」**

**在客戶端（被控端）：**

1. **自動接收同步指令**
2. **狀態訊息顯示「收到同步動作」**
3. **自動開始執行相同操作**
4. **完成後顯示執行結果**

---

## ?? 注意事項

### 1. 網路連線

- ? **同一內網**：直接使用內網 IP 連線
- ? **跨網路**：建議使用 Tailscale 建立虛擬內網
- ?? **公網連線**：需要設定 Port Forwarding 或使用 VPN

### 2. 操作同步

- ?? **執行時間**：複雜操作（如一鍵更新）可能需要較長時間
- ?? **網路延遲**：客戶端執行會有輕微延遲（通常 < 1 秒）
- ?? **失敗處理**：如果客戶端操作失敗，不會影響其他機器

### 3. 連線保持

- ? **背景運行**：關閉 MultiConnect 視窗不會中斷連線
- ? **持續有效**：只要不關閉主程式，連線就會保持
- ?? **重新連線**：如果斷線，需要手動重新連線

### 4. 安全性

- ?? **內網使用**：建議在受信任的內網環境使用
- ?? **操作權限**：所有連線的客戶端都能執行同步操作
- ?? **誤操作風險**：確認操作正確後再執行

---

## ?? 常見問題

### Q1: 為什麼客戶端沒有執行同步操作？

**檢查清單**：
1. ? 確認客戶端狀態顯示「已連線到伺服器」
2. ? 確認伺服器端「自動同步操作」已勾選
3. ? 查看狀態訊息是否顯示「已廣播動作」
4. ? 檢查客戶端狀態訊息是否有錯誤

### Q2: 關閉 MultiConnect 視窗後，連線會斷嗎？

**不會！** 連線會保持在背景運行。
- 查看主視窗頂部的連線狀態
- 只有關閉主程式才會斷線

### Q3: 可以同時啟動伺服器和連線到其他伺服器嗎？

**目前不支援。** 一個程式實例只能選擇：
- 當伺服器（廣播給連線到您的客戶端）
- 當客戶端（接收並執行伺服器的指令）

### Q4: 同步操作會等待所有客戶端完成嗎？

**不會。** 每個客戶端獨立執行，互不影響：
- 伺服器廣播後立即完成
- 各客戶端按自己的速度執行
- 不會等待其他客戶端

### Q5: 執行失敗會通知其他機器嗎？

**目前不會。** 每台機器獨立執行和報告：
- 查看各機器的狀態訊息
- 建議執行完成後檢查每台機器的結果

### Q6: 如何停止所有客戶端的操作？

**方法一**：在伺服器端停止伺服器（會通知所有客戶端斷線）
**方法二**：在各客戶端手動停止操作
**注意**：正在執行的操作無法中途取消

---

## ?? 最佳實踐

### 1. 操作前準備

- ? 確保所有機器都已連線
- ? 檢查連線狀態（查看伺服器顯示的客戶端數量）
- ? 在一台測試機上先執行，確認無誤後再同步所有機器

### 2. 網路環境

- ?? **推薦**：使用 Tailscale 建立安全的虛擬內網
- ? 穩定的網路連線（避免 WiFi 不穩定）
- ? 確保防火牆允許連線

### 3. 監控執行

- ? 觀察各機器的狀態訊息
- ? 注意錯誤訊息
- ? 記錄執行時間和結果

### 4. 錯誤處理

- ? 如果某台機器失敗，不影響其他機器
- ? 失敗的機器可以重新手動執行
- ? 查看詳細錯誤訊息進行除錯

---

## ?? 進階功能（未來可擴充）

以下功能可以根據需求擴充：

1. **操作確認機制**
   - 執行前要求確認
   - 客戶端可以選擇接受或拒絕

2. **執行狀態回報**
   - 客戶端回報執行進度
   - 伺服器顯示所有客戶端狀態

3. **選擇性同步**
   - 只同步特定客戶端
   - 群組管理

4. **操作排程**
   - 定時執行
   - 批次執行多個操作

5. **權限控制**
   - Token 驗證
   - 操作權限管理

---

## ?? 技術支援

如有問題，請查看：
1. **狀態訊息區域**的詳細錯誤資訊
2. **MultiConnect 視窗**的日誌訊息
3. **連線狀態顯示**確認連線正常

**開發資訊**：
- 框架：.NET 6 WPF
- WebSocket：Fleck (Server) + WebSocketSharp (Client)
- 連線管理：全域單例模式
- 訊息格式：JSON

---

*祝您使用愉快！多台同步操作讓管理更輕鬆！*
