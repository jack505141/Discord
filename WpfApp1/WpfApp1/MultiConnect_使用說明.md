# WPF 多台連線系統使用說明

## 功能概述

這個 MultiConnect 視窗提供完整的 WebSocket 主從架構，讓您可以：
- **任何一台電腦都可以當作伺服器**
- **其他電腦可以連線到該伺服器**
- **即時同步訊息廣播**
- **支援多個客戶端同時連線**
- **? 可以在同一台電腦開啟多個視窗，自己連自己進行測試！**

---

## ?? 最簡單的測試方法（同一台電腦）

### 步驟一：開啟第一個視窗（當伺服器）

1. 執行程式，開啟 **MultiConnect** 視窗
2. 在「伺服器設定」區域點擊 **「啟動伺服器」**
3. 看到「伺服器狀態: 運行中 (埠號: 5000)」

### 步驟二：開啟第二個視窗（當客戶端）

1. 點擊頂部工具列的 **「開啟新視窗」** 按鈕
2. 新視窗會自動開啟
3. 在新視窗中點擊 **「快速本機測試」** 按鈕（會自動設定為 127.0.0.1:5000）
4. 點擊 **「連線」** 按鈕

### 步驟三：測試訊息傳送

1. 在任一視窗的輸入框中輸入測試訊息
2. 點擊 **「發送測試訊息」**
3. **兩個視窗都會即時收到訊息！** ??

### 步驟四：開啟更多視窗（可選）

- 繼續點擊 **「開啟新視窗」**，可以開啟 3、4、5 個...無限多個視窗
- 所有連線的視窗都會即時同步收到訊息
- 可以測試多人連線的效果

### 測試場景範例

**場景 1：一對一測試**
- 視窗 1：伺服器
- 視窗 2：客戶端
- 互相發送訊息測試

**場景 2：一對多廣播測試**
- 視窗 1：伺服器
- 視窗 2、3、4：客戶端
- 從伺服器廣播訊息給所有客戶端

**場景 3：客戶端互相通訊**
- 視窗 1：伺服器（不發送訊息，只轉發）
- 視窗 2：發送訊息
- 視窗 3、4：接收來自視窗 2 的訊息

---

## 快速開始（跨電腦）

### 1. 啟動伺服器端

1. 在任意一台電腦上啟動程式，開啟 **MultiConnect** 視窗
2. 在「伺服器設定」區域：
   - 確認埠號（預設 5000，可修改）
   - 點擊 **「啟動伺服器」** 按鈕
   - 查看顯示的本機 IP 位址（例如：192.168.1.100）
3. 伺服器啟動後會顯示「運行中」狀態

### 2. 客戶端連線

1. 在其他電腦上啟動程式，開啟 **MultiConnect** 視窗
2. 在「客戶端連線」區域：
   - 輸入伺服器的 IP 位址（例如：192.168.1.100）
   - 輸入埠號（與伺服器相同，預設 5000）
   - 點擊 **「連線」** 按鈕
3. 連線成功後會顯示「已連線」狀態

### 3. 測試訊息傳送

1. 在下方「日誌訊息」區域的輸入框中輸入測試訊息
2. 點擊 **「發送測試訊息」** 按鈕
3. 所有連線的客戶端都會即時收到該訊息

---

## ?? 快速測試工具說明

頂部的「快速測試工具列」提供了便利功能：

### ?? 開啟新視窗
- **功能**：快速開啟另一個 MultiConnect 視窗
- **用途**：在同一台電腦上測試伺服器與客戶端功能
- **提示**：可以開啟無限多個視窗

### ?? 快速本機測試
- **功能**：自動將伺服器位址設定為 `127.0.0.1:5000`
- **用途**：快速設定連線到本機伺服器
- **使用時機**：當您在同一台電腦有另一個視窗正在運行伺服器時

---

## 網路環境設定

### 情境一：同一內網（最簡單）

**適用環境**：所有電腦都在同一個 WiFi 或有線網路下

1. 伺服器端：啟動伺服器，使用顯示的內網 IP
2. 客戶端：直接使用伺服器的內網 IP 連線
3. 不需要任何額外設定

**範例**：
- 伺服器 IP：192.168.1.100
- 客戶端輸入：192.168.1.100:5000

---

### 情境二：同一台電腦（自己連自己）

**適用環境**：測試、開發、展示

1. **第一個視窗**：啟動伺服器（埠號 5000）
2. **第二個視窗**：
   - 方法 A：點擊「快速本機測試」，然後點「連線」
   - 方法 B：手動輸入 `127.0.0.1` 和埠號 `5000`，然後點「連線」
3. **測試**：在任一視窗發送訊息，兩個視窗都會收到

**連線位址選項**：
- `127.0.0.1` - 標準本機回環位址
- `localhost` - 等同於 127.0.0.1
- 實際 IP（如 `192.168.1.100`）- 也可以連線，但用 127.0.0.1 更快

---

### 情境三：主機有公開 IP（需要 Port Forwarding）

**適用環境**：伺服器在 NAT 路由器後方，但有控制路由器權限

#### 步驟：

1. **設定路由器 Port Forwarding**
   - 登入路由器管理介面（通常是 192.168.1.1）
   - 找到 Port Forwarding / Virtual Server 設定
   - 新增規則： ```
 外部埠：5000
 內部 IP：192.168.1.100（伺服器的內網 IP）
 內部埠：5000
 協定：TCP
 ```
2. **取得公開 IP**
   - 訪問 https://www.whatismyip.com/ 查詢
   - 或在伺服器上執行：`curl ifconfig.me`

3. **客戶端連線**
   - 使用公開 IP + 埠號連線
   - 範例：203.123.45.67:5000

#### 防火牆設定：

**Windows Defender 防火牆**：# 以管理員身份執行 PowerShell
New-NetFirewallRule -DisplayName "MultiConnect Server" -Direction Inbound -LocalPort 5000 -Protocol TCP -Action Allow
---

### 情境四：使用 Tailscale（推薦，最方便跨網路）

**適用環境**：無法設定路由器，或需要跨不同網路連線

#### 優點：
- 不需要 Port Forwarding
- 自動加密連線
- 像在同一內網一樣簡單
- 支援跨平台（Windows、Mac、Linux、手機）

#### 設定步驟：

1. **安裝 Tailscale**
   - 前往 https://tailscale.com/download
   - 下載並安裝到所有需要連線的電腦
   - 登入同一個帳號

2. **取得 Tailscale IP**
   - 安裝後，每台電腦會獲得一個 100.x.x.x 的 IP
   - Windows：查看 Tailscale 系統圖示，或執行 `ipconfig` 找到 Tailscale 網卡
   - 範例：100.90.123.45

3. **使用 Tailscale IP 連線**
   - 伺服器端：啟動伺服器（程式會自動監聽所有介面）
   - 客戶端：使用伺服器的 Tailscale IP 連線
   - 範例：100.90.123.45:5000

---

### 情境五：使用 Cloudflare Tunnel（進階）

**適用環境**：需要從公網存取，但無法使用 Port Forwarding

#### 步驟：

1. **安裝 Cloudflared**# Windows: 下載 cloudflared.exe
# https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation/
2. **建立 Tunnel**cloudflared tunnel --url http://localhost:5000
3. **取得公開 URL**
   - Cloudflared 會顯示一個公開的 URL
   - 將 http:// 改為 ws://

---

## 訊息協定

系統使用 JSON 格式的訊息協定：

### 驗證訊息{
  "type": "auth",
  "clientId": "Client-COMPUTERNAME",
  "timestamp": "2025-01-27 14:30:00"
}
### 測試訊息{
  "type": "test",
  "content": "測試訊息內容",
  "clientId": "Client-COMPUTERNAME",
  "timestamp": "2025-01-27 14:30:00"
}
### 動作訊息（可擴充）{
  "type": "action",
  "actionId": "move-123",
  "timestamp": "2025-01-27 14:30:00",
  "payload": {
    "cmd": "OpenWindow",
    "args": { "windowId": "win1", "title": "Hello" }
  }
}
---

## 常見問題

### Q1: 同一台電腦如何測試？

**最簡單的方法**：
1. 點擊「開啟新視窗」
2. 第一個視窗啟動伺服器
3. 第二個視窗點「快速本機測試」，然後點「連線」
4. 完成！開始測試訊息傳送

### Q2: 可以開啟多少個視窗？

理論上沒有限制！但建議：
- **測試用途**：2-5 個視窗已足夠
- **展示用途**：可以開 10+ 個視窗展示廣播效果
- **效能考量**：每個視窗都會佔用系統資源

### Q3: 為什麼連線失敗？

**檢查清單**（同一台電腦）：
1. ? 確認伺服器視窗已點擊「啟動伺服器」
2. ? 確認客戶端使用 `127.0.0.1` 或 `localhost`
3. ? 確認埠號相同（預設 5000）
4. ? 檢查防火牆是否阻擋（Windows 可能會跳出允許對話框）

**檢查清單**（跨電腦）：
1. ? 確認伺服器已成功啟動（顯示「運行中」）
2. ? 確認 IP 位址正確（同內網用內網 IP，跨網路用 Tailscale IP 或公開 IP）
3. ? 確認埠號相同
4. ? 檢查防火牆是否阻擋連線
5. ? 測試伺服器端口是否開啟：Test-NetConnection -ComputerName 192.168.1.100 -Port 5000
### Q4: 連線後立即斷線

- 檢查防火牆設定
- 確認沒有其他程式佔用該埠號
- 查看日誌訊息中的錯誤資訊

### Q5: 如何取得本機 IP？

**Windows**：ipconfig
# 找到 IPv4 位址
**或在程式中已自動顯示**（伺服器啟動時會顯示）

### Q6: 可以同時當伺服器和客戶端嗎？

**可以！** 一個視窗可以：
- 啟動自己的伺服器（廣播給連線到它的客戶端）
- 同時作為客戶端連線到其他伺服器

**使用場景**：
- 視窗 A：啟動伺服器（埠號 5000）
- 視窗 A：同時連線到視窗 B 的伺服器（埠號 5001）
- 形成網狀連線架構

### Q7: 發送測試訊息按鈕是灰色的？

**原因**：沒有啟動伺服器或連線到伺服器

**解決方法**：
- **方法 A**：啟動伺服器（按鈕會變為可用）
- **方法 B**：連線到其他伺服器（按鈕會變為可用）

---

## ?? 測試範例情境

### 範例 1：基礎測試（2 個視窗）
視窗 1（伺服器）
├─ 啟動伺服器 (Port 5000)
└─ 等待連線

視窗 2（客戶端）
├─ 快速本機測試
├─ 點擊連線
└─ 發送訊息 "Hello from Client"
   └─> 視窗 1 會收到訊息
### 範例 2：多客戶端廣播（4 個視窗）
視窗 1（伺服器）
├─ 啟動伺服器
└─ 發送廣播 "Server: Hello Everyone"
   └─> 視窗 2, 3, 4 都會收到

視窗 2, 3, 4（客戶端）
├─ 連線到 127.0.0.1:5000
└─ 接收來自伺服器和其他客戶端的訊息
### 範例 3：客戶端互相通訊（3 個視窗）
視窗 1（伺服器，純轉發）
└─ 啟動伺服器（不發送訊息）

視窗 2（客戶端 A）
├─ 連線
└─ 發送 "Hello from A"
   └─> 伺服器轉發給視窗 3

視窗 3（客戶端 B）
├─ 連線
├─ 收到來自 A 的訊息
└─ 回覆 "Hi A, this is B"
   └─> 伺服器轉發給視窗 2
---

## 擴充功能建議

目前系統已經實現基本的訊息廣播功能，您可以進一步擴充：

1. **同步特定動作**
   - 視窗開啟/關閉
   - 按鈕點擊
   - 資料更新

2. **增加權限控制**
   - Token 驗證
   - 管理員/普通用戶權限

3. **狀態同步**
   - 定期廣播完整狀態快照
   - 客戶端可請求狀態同步

4. **重連機制**
   - 自動重連（可擴充）
   - 斷線緩衝機制

5. **視窗識別**
   - 為每個視窗命名
   - 顯示連線的視窗列表

---

## 技術資訊

- **框架**: .NET 6 WPF
- **WebSocket 伺服器**: Fleck 1.2.0
- **WebSocket 客戶端**: WebSocketSharp-netstandard 1.0.1
- **序列化**: System.Text.Json
- **預設埠號**: 5000 (可修改)
- **支援同時模式**: 可在同一視窗同時運行伺服器和客戶端

---

## 授權與支援

此功能為 WpfApp1 專案的一部分。
如有問題，請查看日誌訊息區域的詳細錯誤資訊。

**開發提示**：所有連線狀態變化都會記錄在日誌中，方便除錯和追蹤。
